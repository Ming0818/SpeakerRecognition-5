<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <title>Speaker Recognition</title>
  </head>
  <body>

    <div class="container">
      <div class="jumbotron">
        <div class="d-flex justify-content-center">
          <h1>Enroll Speaker</h1>
        </div>
        <div class="d-flex flex-column align-items-center">
          <div class="p-2">
            <input type="email" class="form-control" id="speakerName" placeholder="Speaker Name">
          </div>
          <div class="p-2">
            <button onclick="startRecording(this);">record</button>
            <button onclick="stopRecording(this);" disabled>stop</button>
<!--             <input type="file" class="form-control-file" onclick="uploadBrowsedFile();"> -->
          </div>
          <div class="p-2"><p>Yolo Yolo Yolo Yolo Yolo Yolo Yolo Yolo Yolo </p></div>
        </div>


        <h2>Recordings</h2>
        <ul id="recordingslist"></ul>
        <pre id="log"></pre>
        <script>
        function __log(e, data) {
          log.innerHTML += "\n" + e + " " + (data || '');
        }

        var audio_context;
        var recorder;

        function startUserMedia(stream) {
          var input = audio_context.createMediaStreamSource(stream);
          __log('Media stream created.');
          // Uncomment if you want the audio to feedback directly
          //input.connect(audio_context.destination);
          //__log('Input connected to audio context destination.');
          
          recorder = new Recorder(input);
          __log('Recorder initialised.');
        }

        function startRecording(button) {
          recorder && recorder.record();
          button.disabled = true;
          button.nextElementSibling.disabled = false;
          __log('Recording...');
        }

        function stopRecording(button) {
          recorder && recorder.stop();
          button.disabled = true;
          button.previousElementSibling.disabled = false;
          __log('Stopped recording.');
          
          // create WAV download link using audio data blob
          uploadRecording();
          
          recorder.clear();
        }

        // function uploadBrowsedFile() {
        // }

        function uploadRecording() {
          recorder && recorder.exportWAV(function(blob) {
            // var url = URL.createObjectURL(blob);
            // var li = document.createElement('li');
            // var au = document.createElement('audio');
            // var hf = document.createElement('a');
            // au.controls = true;
            // au.src = url;
            // hf.href = url;
            // hf.download = new Date().toISOString() + '.wav';
            // hf.innerHTML = hf.download;
            // li.appendChild(au);
            // li.appendChild(hf);
            // recordingslist.appendChild(li);

            var filename = document.getElementById("speakerName").value + ".wav";
            var formData = new FormData();
            formData.append("file", blob, filename);

            $.ajax({
               url: "/upload",
               type: "POST",
               data: formData,
               processData: false,
               contentType: false,
               success: function(response) {
                   // .. do something
                   __log('Pathavla');
               },
               error: function(jqXHR, textStatus, errorMessage) {
                   console.log(errorMessage); // Optional
                   __log(textStatus + errorMessage);
               }
            });

            // var reader = new FileReader();
            // reader.onload = function(event){
            //   var fd = {};
            //   fd["file"] = event.target.result;
            //   $.ajax({
            //     type: 'POST',
            //     url: 'http://localhost:5000/upload',
            //     data: fd,
            //     dataType: 'text',
            //     success: function(response) {
            //       __log('Pathavla');
            //     },
            //     error: function(jqXHR, textStatus, errorMessage) {
            //       __log(textStatus + errorMessage);
            //     }
            //   }).done(function(data) {
            //       console.log(data);
            //   });
            // };
            // reader.readAsDataURL(blob);
          });
        }

        window.onload = function init() {
          try {
            // webkit shim
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
            window.URL = window.URL || window.webkitURL;
            
            audio_context = new AudioContext;
            __log('Audio context set up.');
            __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
          } catch (e) {
            alert('No web audio support in this browser!');
          }
          
          navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
            __log('No live audio input: ' + e);
          });
        };
        </script>

        <script src="../static/recorder.js"></script>
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

      </div>
    </div>
  </body>
</html>